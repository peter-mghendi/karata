@page "/play"
@attribute [Authorize]

@using System.Net
@using System.Text.Json.Serialization
@using Karata.Web.Services
@using Microsoft.AspNetCore.SignalR.Client

@implements IAsyncDisposable

@inject AuthenticationStateProvider Authenticator
@inject NavigationManager Navigator
@inject IToastService Toast

@if (hubConnection.State != HubConnectionState.Connected)
{
    <p class="lead">You are not connected to a server</p>
    <p class="text-muted">If this message persists, reload this page to establish a connection.</p>
}
else if (room is null)
{
    <JoinUI OnJoin="JoinRoom" OnCreate="CreateRoom" />
}
else
{
    <div class="container">
        <div class="row">
            <div class="col-8">
                @if (@Game.IsStarted)
                {
                    <GameUI Game="Game" Hand="Hand" @ref="gameUI" OnPerformTurn="PerformTurn" />
                }
                else
                {
                    <CardTable />
                }
            </div>
            <div class="col-4" style="height: calc(100vh - 5rem); overflow-y: auto;">
                <DetailsUI Room="room" Player="Player" OnSend="Send" OnStartGame="StartGame" OnLeaveRoom="LeaveRoom" />
            </div>
        </div>
    </div>
}

@code {
    [Inject]
    public CookieService CookieService { get; set; }
    [CascadingParameter]
    private IModalService ModalService { get; set; }
    private HubConnection hubConnection;
    private string username;
    private GameUI gameUI;
    private Room room = null;
    private Game Game => room.Game;
    private Hand Hand => Game.Hands.Single(h => h.User.Email == username);
    private User Player => Hand.User;

    protected override async Task OnInitializedAsync()
    {
        // Get username from AuthenticationStateProvider
        var authState = await Authenticator.GetAuthenticationStateAsync();
        username = authState.User.Identity.Name;

        // Set up SignalR with Cookie auth
        var container = new CookieContainer();
        container.Add(new Cookie
        {
            Name = ".AspNetCore.Identity.Application",
            Domain = "localhost",
            Value = CookieService.Cookie
        });

        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigator.ToAbsoluteUri("/game"), opts => opts.Cookies = container)
        .AddJsonProtocol(opts =>
        {
            opts.PayloadSerializerOptions.ReferenceHandler = ReferenceHandler.Preserve;
        })
        .Build();

        hubConnection.On<uint>("AddCardsToDeck", num =>
        {
            for (int i = 0; i < num; i++) Game.Deck.Push(Ace.Of(Spades));
            StateHasChanged();
        });

        hubConnection.On<Card>("AddCardToHand", card =>
        {
            Hand.Cards.Add(card);
            StateHasChanged();
        });

        hubConnection.On<Card>("AddCardToPile", card =>
        {
            Game.Pile.Push(card);
            StateHasChanged();
        });

        hubConnection.On<List<Card>>("AddCardRangeToHand", cards =>
        {
            Hand.Cards.AddRange(cards);
            StateHasChanged();
        });

        hubConnection.On<List<Card>>("AddCardRangeToPile", cards =>
        {
            foreach (var card in cards) Game.Pile.Push(card);
            StateHasChanged();
        });

        hubConnection.On<Hand>("AddHandToRoom", hand =>
        {
            Game.Hands.Add(hand);
            Toast.ShowInfo($"{hand.User.Email} has joined the room");
            StateHasChanged();
        });

        hubConnection.On<Room>("AddToRoom", room =>
        {
            this.room = room;
            StateHasChanged();
        });

        hubConnection.On<User>("EndGame", winner =>
        {            
            Toast.ShowInfo($"Game over! {(winner?.Email ?? "Nobody")} won this game.");
            room = null;
            StateHasChanged();
        });

        hubConnection.On<bool>("NotifyTurnProcessed", valid => gameUI.NotifyTurnPerformed(valid));

        hubConnection.On<bool>("PromptCardRequest", async specific =>
        {
            var parameters = new ModalParameters();
            parameters.Add(nameof(CardRequestModal.Specific), specific);
            var options = new ModalOptions { DisableBackgroundCancel = true };
            var modal = ModalService.Show<CardRequestModal>("Request a card", parameters, options);
            var result = await modal.Result;
            await hubConnection.SendAsync("RequestCard", (Card)result.Data);
        });

        hubConnection.On("PromptLastCardRequest", async () =>
        {
            var options = new ModalOptions { 
                DisableBackgroundCancel = true, 
                HideCloseButton = true
            };
            var modal = ModalService.Show<LastCardPromptModal>("Last card?", options);
            var result = await modal.Result;
            await hubConnection.SendAsync("SetLastCardStatus", (bool)result.Data);
        });

        hubConnection.On<Chat>("ReceiveChat", message =>
        {
            room.Chats.Add(message);
            StateHasChanged();
        });

        hubConnection.On<SystemMessage>("ReceiveSystemMessage", message =>
        {
            var level = message.Type switch
            {
                MessageType.Error => ToastLevel.Error,
                MessageType.Info => ToastLevel.Info,
                MessageType.Success => ToastLevel.Success,
                MessageType.Warning => ToastLevel.Warning,
                _ => throw new ArgumentException("Invalid message type.", nameof(MessageType))
            };
            Toast.ShowToast(level, message.Text);
        });

        hubConnection.On("ReclaimPile", () =>
        {
            _ = Game.Pile.Reclaim();
            StateHasChanged();
        });

        hubConnection.On<uint>("RemoveCardsFromDeck", num =>
        {
            _ = Game.Deck.DealMany(num);
            StateHasChanged();
        });

        hubConnection.On("RemoveFromRoom", () =>
        {
            room = null;
            StateHasChanged();
        });

        hubConnection.On<Hand>("RemoveHandFromRoom", hand =>
        {
            _ = Game.Hands.Remove(hand);
            Toast.ShowInfo($"{hand.User.Email} has left the room.");
            StateHasChanged();
        });

        hubConnection.On<Card>("SetCurrentRequest", request =>
        {
            Game.CurrentRequest = request;
            StateHasChanged();
        });

        hubConnection.On<int>("UpdateTurn", turn =>
        {
            Game.CurrentTurn = turn;
            StateHasChanged();
        });

        hubConnection.On<bool>("UpdateGameStatus", started =>
        {
            Game.IsStarted = started;
            if (started) Toast.ShowInfo("The game has started.");
            StateHasChanged();
        });

        await hubConnection.StartAsync();
    }

    async Task Send(string message) =>
        await hubConnection.SendAsync("SendChat", room.InviteLink, message);

    async Task CreateRoom(string password) => await hubConnection.SendAsync("CreateRoom", password);

    async Task JoinRoom((string InviteLink, string Password) room) => 
        await hubConnection.SendAsync("JoinRoom", room.InviteLink, room.Password);

    async Task LeaveRoom() => await hubConnection.SendAsync("LeaveRoom", room.InviteLink);

    async Task StartGame() => await hubConnection.SendAsync("StartGame", room.InviteLink);

    async Task PerformTurn(List<Card> cards)
    {
        await hubConnection.SendAsync("PerformTurn", room.InviteLink, cards);
        StateHasChanged();
    }

    public async ValueTask DisposeAsync() => await hubConnection.DisposeAsync();
}