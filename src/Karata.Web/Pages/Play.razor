@page "/play"
@attribute [Authorize]

@using System.Net
@using System.Text.Json.Serialization
@using Karata.Web.Services
@using Microsoft.AspNetCore.SignalR.Client

@implements IAsyncDisposable

@inject AuthenticationStateProvider Authenticator
@inject NavigationManager Navigator
@inject IConfiguration Config
@inject ISnackbar Snackbar

@if (hubConnection.State != HubConnectionState.Connected)
{
    <MudText Typo="Typo.h5" Class="pa-4 my-4">You are not connected to a server.</MudText>
    <MudText Typo="Typo.h6" Class="pa-4 mb-4">If this message persists, reload this page to establish a connection.</MudText>
}
else if (room is null)
{
    <JoinUI OnJoin="JoinRoom" OnCreate="CreateRoom" />
}
else
{
    <MudDrawerContainer Class="mud-height-full">
        <MudDrawer @bind-Open="open" Height="100%" Elevation="1" Variant="@DrawerVariant.Temporary" Anchor="Anchor.Bottom" Class="grey lighten-4">
            <MudDrawerHeader Class="d-flex justify-space-between align-center pa-2">
                <MudText Typo="Typo.h6" Class="px-4">Game Info</MudText>
                <MudIconButton Icon="@Icons.Rounded.Close" Color="Color.Inherit" OnClick="() => open = false" />
            </MudDrawerHeader>
            <MudContainer MaxWidth="MaxWidth.Medium">
                <MudPaper Class="pa-4 mb-4" Elevation="0">
                    <div class="mb-2">
                        <MudSwitch @bind-Checked="useCardTable" Color="Color.Primary" Label="Use CardTable UI (Experimental)" />
                    </div>
                    <MudText Typo="Typo.caption" Class="text-grey">
                        The CardTable UI is still under development and, as such, may contain bugs. Use GameUI for best experience.
                    </MudText>
                </MudPaper>
                
                <DetailsUI Room="room" Player="Player" OnSend="Send" />
            </MudContainer>
        </MudDrawer>
        <MudPaper Elevation="0" Class="my-4">
            <MudToolBar>
                @if (@Game.IsStarted)
                {
                    <MudTooltip Text="Pick card(s)">
                        <MudIconButton Icon="@Icons.Rounded.ArrowCircleUp" Color="Color.Inherit" OnClick="() => PerformTurn(new())" />
                    </MudTooltip>
                    <MudTooltip Text="Play card(s)">
                        <MudIconButton Icon="@Icons.Rounded.ArrowCircleDown" Color="Color.Inherit" OnClick="() => PerformTurn(currentTurn)" />
                    </MudTooltip>
                }

                <MudSpacer />

                @if (!@Game.IsStarted)
                {
                    <MudTooltip Text="Start Game">
                        <MudIconButton Icon="@Icons.Rounded.PlayArrow" Color="Color.Inherit" OnClick="StartGame" />
                    </MudTooltip>
                }

                <MudTooltip Text="Leave Room">
                    <MudIconButton Icon="@Icons.Rounded.PersonRemove" Color="Color.Inherit" OnClick="LeaveRoom" />
                </MudTooltip>
                <MudTooltip Text="Game Details">
                    <MudIconButton Icon="@Icons.Rounded.Info" Color="Color.Inherit" OnClick="() => open = true" />
                </MudTooltip>
            </MudToolBar>
        </MudPaper>
        @if (@Game.IsStarted)
        {
            if (useCardTable)
            {
                <CardTable Game="Game" Hand="Hand" Turn="currentTurn" OnAddCardToTurn="AddCardToTurn" OnRemoveCardFromTurn="RemoveCardFromTurn" />
            }
            else
            {
                <GameUI Game="Game" Hand="Hand" Turn="currentTurn" OnAddCardToTurn="AddCardToTurn" OnRemoveCardFromTurn="RemoveCardFromTurn" />
            }
        }
        else
        {
            <MudText Typo="Typo.h5" Class="pa-4 mb-4">Waiting for players to join. (@Game.Hands.Count/4)</MudText>
        }
    </MudDrawerContainer>
}

@code {
    [Inject]
    public CookieService CookieService { get; set; }
    [Inject] 
    private IDialogService DialogService { get; set; }
    private HubConnection hubConnection;
    private string username;
    private UIRoom room = null;
    private UIGame Game => room.Game;
    private UIHand Hand => Game.Hands.Single(h => h.User.Email == username);
    private UIUser Player => Hand.User;
    private List<Card> currentTurn = new();
    private bool useCardTable = false;
    bool open = false;

    protected override async Task OnInitializedAsync()
    {
        // Get username from AuthenticationStateProvider
        var authState = await Authenticator.GetAuthenticationStateAsync();
        username = authState.User.Identity.Name;

        // Set up SignalR with Cookie auth
        var container = new CookieContainer();
        container.Add(new Cookie
        {
            Name = ".AspNetCore.Identity.Application",
            Domain = Config["CookieDomain"],
            Value = CookieService.Cookie
        });

        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigator.ToAbsoluteUri("/game"), opts => opts.Cookies = container)
        .AddJsonProtocol(opts =>
        {
            opts.PayloadSerializerOptions.ReferenceHandler = ReferenceHandler.Preserve;
        })
        .Build();

        hubConnection.On<int>("AddCardsToDeck", num =>
        {
            Game.DeckCount += num;
            StateHasChanged();
        });

        hubConnection.On<Card>("AddCardToPile", card =>
        {
            Game.Pile.Push(card);
            StateHasChanged();
        });

        hubConnection.On<UIHand, int>("AddCardsToPlayerHand", (hand, num) =>
        {
            var playerHand = Game.Hands.Single(h => h.User.Email == hand.User.Email);
            for (int i = 0; i < num; i++) playerHand.Cards.Add(new());
            StateHasChanged();
        });

        hubConnection.On<List<Card>>("AddCardRangeToHand", cards =>
        {
            Hand.Cards.AddRange(cards);
            StateHasChanged();
        });

        hubConnection.On<List<Card>>("AddCardRangeToPile", cards =>
        {
            foreach (var card in cards) Game.Pile.Push(card);
            StateHasChanged();
        });

        hubConnection.On<UIHand>("AddHandToRoom", hand =>
        {
            Game.Hands.Add(hand);
            Snackbar.Add($"{hand.User.Email} has joined the room", Severity.Info);
            StateHasChanged();
        });

        hubConnection.On<UIRoom>("AddToRoom", room =>
        {
            this.room = room;
            StateHasChanged();
        });

        hubConnection.On<UIUser>("EndGame", winner =>
        {
            Snackbar.Add($"Game over! {(winner?.Email ?? "Nobody")} won this game.", Severity.Info);
            room = null;
            StateHasChanged();
        });

        hubConnection.On("NotifyTurnProcessed", () =>
        {
            currentTurn.Clear();
            StateHasChanged();
        });

        hubConnection.On<bool>("PromptCardRequest", async specific =>
        {
            var parameters = new DialogParameters();
            parameters.Add(nameof(CardRequestModal.Specific), specific);
            var dialog = DialogService.Show<CardRequestModal>("Request a card", parameters);
            var result = await dialog.Result;
            var data = result.Cancelled ? null : (Card)result.Data;
            await hubConnection.SendAsync("RequestCard", data);
        });

        hubConnection.On("PromptLastCardRequest", async () =>
        {
            var dialog = DialogService.ShowMessageBox("Last Card?", "Are you on your last card?", "Yes!", "No");
            var result = await dialog ?? false;
            await hubConnection.SendAsync("SetLastCardStatus", result);
        });

        hubConnection.On<UIChat>("ReceiveChat", message =>
        {
            room.Chats.Add(message);
            var sender = message.Sender.Email;
            if(sender != username) Snackbar.Add($"New message from {sender}.", Severity.Info);
            StateHasChanged();
        });

        hubConnection.On<SystemMessage>("ReceiveSystemMessage", message =>
        {
            var severity = message.Type switch
            {
                MessageType.Error => Severity.Error,
                MessageType.Info => Severity.Info,
                MessageType.Success => Severity.Success,
                MessageType.Warning => Severity.Warning,
                _ => throw new ArgumentException("Invalid message type.", nameof(MessageType))
            };
            Snackbar.Add(message.Text, severity);
        });

        hubConnection.On("ReclaimPile", () =>
        {
            _ = Game.Pile.Reclaim();
            StateHasChanged();
        });

        hubConnection.On<int>("RemoveCardsFromDeck", num =>
        {
            Game.DeckCount -= num;
            StateHasChanged();
        });

        hubConnection.On<UIHand, int>("RemoveCardsFromPlayerHand", (hand, num) =>
        {
            var playerHand = Game.Hands.Single(h => h.User.Email == hand.User.Email);
            for (int i = 0; i < num; i++) playerHand.Cards.RemoveAt(0);
            StateHasChanged();
        });

        hubConnection.On<List<Card>>("RemoveCardRangeFromHand", cards =>
        {
            Hand.Cards.RemoveAll(c => cards.Contains(c));
            StateHasChanged();
        });

        hubConnection.On("RemoveFromRoom", () =>
        {
            room = null;
            StateHasChanged();
        });

        hubConnection.On<UIHand>("RemoveHandFromRoom", hand =>
        {
            _ = Game.Hands.Remove(hand);
            Snackbar.Add($"{hand.User.Email} has left the room.", Severity.Info);
            StateHasChanged();
        });

        hubConnection.On<Card>("SetCurrentRequest", request =>
        {
            Game.CurrentRequest = request;
            StateHasChanged();
        });

        hubConnection.On<int>("UpdateTurn", turn =>
        {
            Game.CurrentTurn = turn;
            var current = Game.Hands[turn].User.Email;
            var turnText = current == username ? "your" : $"{current}'s";
            var message = $"It is now {turnText} turn.";
            Snackbar.Add(message, Severity.Info);
            StateHasChanged();
        });

        hubConnection.On<bool>("UpdateGameStatus", started =>
        {
            Game.IsStarted = started;
            if (started) Snackbar.Add($"The game has started", Severity.Info);
            StateHasChanged();
        });

        await hubConnection.StartAsync();
    }

    async Task Send(string message) =>
    await hubConnection.SendAsync("SendChat", room.InviteLink, message);

    async Task CreateRoom(string password) => await hubConnection.SendAsync("CreateRoom", password);

    async Task JoinRoom((string InviteLink, string Password) room) =>
    await hubConnection.SendAsync("JoinRoom", room.InviteLink, room.Password);

    async Task LeaveRoom() => await hubConnection.SendAsync("LeaveRoom", room.InviteLink);

    async Task StartGame() => await hubConnection.SendAsync("StartGame", room.InviteLink);

    private void AddCardToTurn(Card card)
    {
        currentTurn.Add(card);
        StateHasChanged();
    }

    private void RemoveCardFromTurn(Card card)
    {
        currentTurn.Remove(card);
        StateHasChanged();
    }

    async Task PerformTurn(List<Card> cards)
    {
        await hubConnection.SendAsync("PerformTurn", room.InviteLink, cards);
        StateHasChanged();
    }

    public async ValueTask DisposeAsync() => await hubConnection.DisposeAsync();
}